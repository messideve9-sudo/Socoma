<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de Bord - SOCoMA</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin: 30px 0;
        }
        
        .kpi-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            text-align: center;
            border-top: 4px solid;
            transition: all 0.3s ease;
        }
        
        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        
        .kpi-card.blue { border-top-color: #3498db; }
        .kpi-card.green { border-top-color: #27ae60; }
        .kpi-card.orange { border-top-color: #f39c12; }
        .kpi-card.red { border-top-color: #e74c3c; }
        .kpi-card.purple { border-top-color: #9b59b6; }
        
        .kpi-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
            opacity: 0.8;
        }
        
        .kpi-value {
            font-size: 2.2rem;
            font-weight: 800;
            margin: 15px 0;
            color: #2c3e50;
        }
        
        .kpi-label {
            font-size: 14px;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }
        
        .kpi-trend {
            font-size: 13px;
            font-weight: 600;
            margin-top: 10px;
        }
        
        .kpi-trend.positive { color: #27ae60; }
        .kpi-trend.negative { color: #e74c3c; }
        
        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin: 30px 0;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        }
        
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
        }
        
        .chart-wrapper {
            height: 300px;
            position: relative;
        }
        
        .alert-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .alert-item {
            padding: 15px;
            border-left: 4px solid;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .alert-item.warning { border-left-color: #f39c12; }
        .alert-item.danger { border-left-color: #e74c3c; }
        .alert-item.info { border-left-color: #3498db; }
        
        .performance-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
        }
        
        .performance-excellent { background: #27ae60; color: white; }
        .performance-good { background: #3498db; color: white; }
        .performance-average { background: #f39c12; color: white; }
        .performance-poor { background: #e74c3c; color: white; }
        
        .commercial-performance {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }
        
        .commercial-rank {
            width: 40px;
            height: 40px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
        }
        
        .commercial-info {
            flex: 1;
        }
        
        .commercial-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .progress-bar {
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 5px 0;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 4px;
        }
        
        .progress-fill.excellent { background: #27ae60; }
        .progress-fill.good { background: #3498db; }
        .progress-fill.average { background: #f39c12; }
        .progress-fill.poor { background: #e74c3c; }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="logo-container">
            <div class="logo">
                <i class="fas fa-chart-line"></i>
            </div>
            <div>
                <h1>Suivi des Créances - SOCoMA</h1>
                <p class="subtitle">Tableau de Bord</p>
            </div>
        </div>
        
        <div class="main-nav">
            <a href="{{ url_for('accueil') }}" class="nav-link">
                <i class="fas fa-home"></i> Accueil
            </a>
            <a href="{{ url_for('liste_creances') }}" class="nav-link">
                <i class="fas fa-file-invoice-dollar"></i> Créances
            </a>
            <a href="{{ url_for('tableau_bord') }}" class="nav-link active">
                <i class="fas fa-chart-bar"></i> Tableau de Bord
            </a>
            <a href="{{ url_for('commerciaux') }}" class="nav-link">
                <i class="fas fa-users"></i> Commerciaux
            </a>
            {% if current_user.role == 'admin' %}
            <a href="{{ url_for('gestion_utilisateurs') }}" class="nav-link">
                <i class="fas fa-cog"></i> Paramètres
            </a>
            {% endif %}
            
            <div class="user-info">
                <span>
                    <i class="fas fa-user"></i> {{ current_user.username }}
                    <span class="user-role">{{ current_user.role|upper }}</span>
                </span>
                <a href="{{ url_for('logout') }}" class="btn btn-danger btn-small">
                    <i class="fas fa-sign-out-alt"></i> Déconnexion
                </a>
            </div>
        </div>
    </div>

    <div class="container">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">
                        <i class="fas fa-{% if category == 'success' %}check-circle{% else %}exclamation-circle{% endif %}"></i>
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="content">
            <!-- En-tête du tableau de bord -->
            <div class="dashboard-header">
                <h2><i class="fas fa-chart-line"></i> Tableau de Bord - Vue d'ensemble</h2>
                <p>Performance globale et indicateurs clés - Mise à jour: {{ now.strftime('%d/%m/%Y à %H:%M') }}</p>
            </div>

            <!-- KPI Principaux -->
            <div class="kpi-grid">
                <div class="kpi-card blue">
                    <div class="kpi-icon">
                        <i class="fas fa-money-check-alt"></i>
                    </div>
                    <div class="kpi-value">{{ total_creances|format_money }}</div>
                    <div class="kpi-label">Total des Créances</div>
                    <div class="kpi-trend positive">
                        <i class="fas fa-chart-line"></i> 4 commerciaux actifs
                    </div>
                </div>
                
                <div class="kpi-card green">
                    <div class="kpi-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="kpi-value">{{ (total_creances - total_solde)|format_money }}</div>
                    <div class="kpi-label">Déjà Soldé</div>
                    <div class="kpi-trend positive">
                        {% if total_creances > 0 %}
                            {{ (((total_creances - total_solde) / total_creances) * 100)|round(2) }}% du total
                        {% else %}
                            0%
                        {% endif %}
                    </div>
                </div>
                
                <div class="kpi-card orange">
                    <div class="kpi-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="kpi-value">{{ montant_a_solder|format_money }}</div>
                    <div class="kpi-label">À Solder</div>
                    <div class="kpi-trend {% if montant_a_solder > 0 %}negative{% else %}positive{% endif %}">
                        {% if total_creances > 0 %}
                            {{ ((montant_a_solder / total_creances) * 100)|round(2) }}% du total
                        {% else %}
                            0%
                        {% endif %}
                    </div>
                </div>
                
                <div class="kpi-card red">
                    <div class="kpi-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="kpi-value">{{ montant_retard|format_money }}</div>
                    <div class="kpi-label">En Retard</div>
                    <div class="kpi-trend negative">
                        TPAR: {{ tpar|round(2) }}%
                    </div>
                </div>
                
                <div class="kpi-card purple">
                    <div class="kpi-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="kpi-value">{{ creances_retard|length }}</div>
                    <div class="kpi-label">Créances en Retard</div>
                    <div class="kpi-trend {% if creances_retard|length > 0 %}negative{% else %}positive{% endif %}">
                        {% if creances_retard|length > 0 %}
                            {{ creances_retard|length }} nécessitent suivi
                        {% else %}
                            Aucun retard
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Graphiques -->
            <div class="chart-grid">
                <div class="chart-container">
                    <h3><i class="fas fa-chart-bar"></i> Performance par Commercial</h3>
                    <div class="chart-wrapper">
                        <canvas id="chartPerformance"></canvas>
                    </div>
                </div>
                
                <div class="chart-container">
                    <h3><i class="fas fa-chart-pie"></i> Répartition des Créances</h3>
                    <div class="chart-wrapper">
                        <canvas id="chartRepartition"></canvas>
                    </div>
                </div>
            </div>

            <!-- Performance des commerciaux -->
            <div class="chart-container">
                <h3><i class="fas fa-trophy"></i> Classement des Commerciaux</h3>
                <div class="commercial-performance-list">
                    {% for commercial, stats in stats_commerciaux.items() %}
                    <div class="commercial-performance">
                        <div class="commercial-rank">{{ loop.index }}</div>
                        <div class="commercial-info">
                            <div class="d-flex justify-between align-center">
                                <div class="commercial-name">{{ commercial }}</div>
                                <div>
                                    <span class="performance-badge 
                                        {% if (stats.total - stats.retard)/stats.total > 0.9 %}performance-excellent
                                        {% elif (stats.total - stats.retard)/stats.total > 0.7 %}performance-good
                                        {% elif (stats.total - stats.retard)/stats.total > 0.5 %}performance-average
                                        {% else %}performance-poor{% endif %}">
                                        {% if stats.total > 0 %}
                                            {{ (((stats.total - stats.retard) / stats.total) * 100)|round(0) }}%
                                        {% else %}
                                            0%
                                        {% endif %}
                                    </span>
                                </div>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill 
                                    {% if (stats.total - stats.retard)/stats.total > 0.9 %}excellent
                                    {% elif (stats.total - stats.retard)/stats.total > 0.7 %}good
                                    {% elif (stats.total - stats.retard)/stats.total > 0.5 %}average
                                    {% else %}poor{% endif %}" 
                                    style="width: {% if stats.total > 0 %}{{ ((stats.total - stats.retard) / stats.total) * 100 }}%{% else %}0%{% endif %}">
                                </div>
                            </div>
                            <div style="font-size: 13px; color: #7f8c8d;">
                                {{ stats.total|format_money }} total • 
                                {{ stats.retard|format_money }} en retard • 
                                {{ stats.count }} créance(s)
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Alertes et actions -->
            <div class="chart-grid">
                <div class="chart-container">
                    <h3><i class="fas fa-exclamation-circle"></i> Alertes à Suivre</h3>
                    <div class="alert-list">
                        {% if top_retard %}
                            {% for creance in top_retard %}
                            <div class="alert-item danger">
                                <div class="d-flex justify-between align-center">
                                    <div>
                                        <strong>{{ creance.client }}</strong>
                                        <div style="font-size: 14px; color: #666; margin-top: 5px;">
                                            {{ creance.commercial }} • {{ creance.solde|format_money }}
                                        </div>
                                    </div>
                                    <div>
                                        <span class="badge badge-danger">{{ creance.jours_retard }} jours retard</span>
                                    </div>
                                </div>
                                <div style="margin-top: 10px;">
                                    <a href="{{ url_for('modifier_creance', id=creance.id) }}" class="btn btn-small btn-warning">
                                        <i class="fas fa-edit"></i> Modifier
                                    </a>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="alert-item info">
                                <i class="fas fa-check-circle"></i> Aucune alerte pour le moment
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="chart-container">
                    <h3><i class="fas fa-bolt"></i> Actions Rapides</h3>
                    <div class="d-flex flex-column gap-10">
                        <a href="{{ url_for('ajouter_creance') }}" class="btn btn-success btn-block">
                            <i class="fas fa-plus-circle"></i> Ajouter une Créance
                        </a>
                        <a href="{{ url_for('liste_creances') }}" class="btn btn-primary btn-block">
                            <i class="fas fa-list"></i> Voir Toutes les Créances
                        </a>
                        <a href="{{ url_for('export_excel') }}" class="btn btn-info btn-block">
                            <i class="fas fa-file-excel"></i> Exporter Excel
                        </a>
                        {% if current_user.role == 'admin' %}
                        <a href="{{ url_for('admin_reset_creances') }}" class="btn btn-warning btn-block">
                            <i class="fas fa-redo"></i> Administration
                        </a>
                        {% endif %}
                    </div>
                    
                    <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                        <h4><i class="fas fa-lightbulb"></i> Recommandations</h4>
                        <ul style="margin-top: 10px; padding-left: 20px;">
                            {% if tpar > 20 %}
                            <li>TPAR élevé ({{ tpar|round(2) }}%) - Renforcer le suivi des retards</li>
                            {% endif %}
                            {% if montant_a_solder > total_creances * 0.3 %}
                            <li>Important montant à solder - Planifier les relances</li>
                            {% endif %}
                            {% if creances_retard|length > 5 %}
                            <li>{{ creances_retard|length }} créances en retard - Actions prioritaires nécessaires</li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
            </div>

                        <!-- Statistiques détaillées -->
            <div class="chart-container">
                <h3><i class="fas fa-chart-line"></i> Statistiques Détailées</h3>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Commercial</th>
                                <th>Total Créances</th>
                                <th>À Solder</th>
                                <th>En Retard</th>
                                <th>TPAR</th>
                                <th>Performance</th>
                                <th>Nombre Clients</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for commercial, stats in stats_commerciaux.items() %}
                            <tr>
                                <td><strong>{{ commercial }}</strong></td>
                                <td>{{ stats.total|format_money }}</td>
                                <td>{{ stats.solde|format_money }}</td>
                                <td class="{% if stats.retard > 0 %}text-danger{% endif %}">
                                    {{ stats.retard|format_money }}
                                </td>
                                <td>
                                    {% if stats.total > 0 %}
                                        <span class="{% if (stats.retard/stats.total*100) > 20 %}text-danger{% elif (stats.retard/stats.total*100) > 10 %}text-warning{% else %}text-success{% endif %}">
                                            {{ (stats.retard/stats.total*100)|round(2) }}%
                                        </span>
                                    {% else %}
                                        0%
                                    {% endif %}
                                </td>
                                <td>
                                    {% if stats.total > 0 %}
                                        {% set performance = ((stats.total - stats.retard) / stats.total) * 100 %}
                                        {% if performance >= 90 %}
                                            <span class="performance-excellent">{{ performance|round(0) }}%</span>
                                        {% elif performance >= 70 %}
                                            <span class="performance-good">{{ performance|round(0) }}%</span>
                                        {% elif performance >= 50 %}
                                            <span class="performance-average">{{ performance|round(0) }}%</span>
                                        {% else %}
                                            <span class="performance-poor">{{ performance|round(0) }}%</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>{{ stats.count }}</td>
                                <td>
                                    <a href="{{ url_for('liste_creances') }}?commercial={{ commercial }}" 
                                       class="btn btn-small btn-primary">
                                        <i class="fas fa-eye"></i> Voir
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr style="background: #f8f9fa; font-weight: bold;">
                                <td>TOTAL</td>
                                <td>{{ total_creances|format_money }}</td>
                                <td>{{ montant_a_solder|format_money }}</td>
                                <td>{{ montant_retard|format_money }}</td>
                                <td>{{ tpar|round(2) }}%</td>
                                <td>
                                    {% set perf_totale = ((total_creances - montant_retard) / total_creances * 100) if total_creances > 0 else 0 %}
                                    {% if perf_totale >= 90 %}
                                        <span class="performance-excellent">{{ perf_totale|round(0) }}%</span>
                                    {% elif perf_totale >= 70 %}
                                        <span class="performance-good">{{ perf_totale|round(0) }}%</span>
                                    {% elif perf_totale >= 50 %}
                                        <span class="performance-average">{{ perf_totale|round(0) }}%</span>
                                    {% else %}
                                        <span class="performance-poor">{{ perf_totale|round(0) }}%</span>
                                    {% endif %}
                                </td>
                                <td>{{ stats_commerciaux.values()|sum(attribute='count') }}</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer">
        <p>Suivi des Créances - SOCoMA &copy; {{ now.year }}</p>
        <p class="footer-links">
            <a href="{{ url_for('accueil') }}">Accueil</a> • 
            <a href="{{ url_for('liste_creances') }}">Créances</a> • 
            <a href="{{ url_for('recap_clients') }}">Clients</a>
        </p>
    </div>

    <script>
        // Initialisation des graphiques
        document.addEventListener('DOMContentLoaded', function() {
            // Données pour les graphiques
            const commerciaux = {{ stats_commerciaux.keys()|list|tojson }};
            const totals = {{ stats_commerciaux.values()|map(attribute='total')|list|tojson }};
            const retards = {{ stats_commerciaux.values()|map(attribute='retard')|list|tojson }};
            const soldes = {{ stats_commerciaux.values()|map(attribute='solde')|list|tojson }};

            // Graphique de performance
            const ctxPerformance = document.getElementById('chartPerformance').getContext('2d');
            new Chart(ctxPerformance, {
                type: 'bar',
                data: {
                    labels: commerciaux,
                    datasets: [
                        {
                            label: 'Total Créances',
                            data: totals,
                            backgroundColor: '#3498db',
                            borderColor: '#2980b9',
                            borderWidth: 1
                        },
                        {
                            label: 'En Retard',
                            data: retards,
                            backgroundColor: '#e74c3c',
                            borderColor: '#c0392b',
                            borderWidth: 1
                        },
                        {
                            label: 'À Solder',
                            data: soldes,
                            backgroundColor: '#f39c12',
                            borderColor: '#e67e22',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += new Intl.NumberFormat('fr-FR').format(context.raw) + ' FCFA';
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    if (value >= 1000000) {
                                        return (value / 1000000).toFixed(1) + 'M';
                                    }
                                    if (value >= 1000) {
                                        return (value / 1000).toFixed(0) + 'K';
                                    }
                                    return value;
                                }
                            }
                        }
                    }
                }
            });

            // Graphique de répartition
            const ctxRepartition = document.getElementById('chartRepartition').getContext('2d');
            
            // Calculer les pourcentages
            const totalMontant = totals.reduce((a, b) => a + b, 0);
            const percentages = totals.map(total => 
                totalMontant > 0 ? (total / totalMontant * 100).toFixed(1) : 0
            );
            
            new Chart(ctxRepartition, {
                type: 'doughnut',
                data: {
                    labels: commerciaux.map((com, i) => `${com} (${percentages[i]}%)`),
                    datasets: [{
                        data: totals,
                        backgroundColor: [
                            '#3498db',
                            '#27ae60',
                            '#f39c12',
                            '#e74c3c',
                            '#9b59b6',
                            '#1abc9c'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const percentage = totalMontant > 0 ? 
                                        ((value / totalMontant) * 100).toFixed(1) : 0;
                                    return `${context.label}: ${new Intl.NumberFormat('fr-FR').format(value)} FCFA (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // Mettre à jour l'heure de mise à jour toutes les minutes
            function updateTime() {
                const now = new Date();
                const timeElement = document.querySelector('.dashboard-header p');
                if (timeElement) {
                    timeElement.textContent = `Performance globale et indicateurs clés - Mise à jour: ${now.toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'})}`;
                }
            }
            
            setInterval(updateTime, 60000);
        });
    </script>
</body>
</html>
