<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modifier Créance - SOCoMA</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .creance-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            border-left: 4px solid #3498db;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .info-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .info-label {
            font-size: 12px;
            color: #7f8c8d;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .info-value {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .montant-section {
            background: linear-gradient(135deg, #667eea20 0%, #764ba220 100%);
            padding: 20px;
            border-radius: 10px;
            margin: 25px 0;
        }
        
        .montant-calc {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }
        
        .montant-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }
        
        .montant-label {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 8px;
        }
        
        .montant-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .statut-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
        }
        
        .statut-a-relancer { background: #ffeaa7; color: #d63031; }
        .statut-a-surveiller { background: #a29bfe; color: #2d3436; }
        .statut-aujourd-hui { background: #81ecec; color: #0984e3; }
        .statut-paye { background: #55efc4; color: #00b894; }
        .statut-en-retard { background: #fd79a8; color: #e84393; }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="logo-container">
            <div class="logo">
                <i class="fas fa-chart-line"></i>
            </div>
            <div>
                <h1>Suivi des Créances - SOCoMA</h1>
                <p class="subtitle">Modifier la créance #{{ creance.id }}</p>
            </div>
        </div>
        
        <div class="main-nav">
            <a href="{{ url_for('accueil') }}" class="nav-link">
                <i class="fas fa-home"></i> Accueil
            </a>
            <a href="{{ url_for('liste_creances') }}" class="nav-link">
                <i class="fas fa-file-invoice-dollar"></i> Créances
            </a>
            <a href="{{ url_for('tableau_bord') }}" class="nav-link">
                <i class="fas fa-chart-bar"></i> Tableau de Bord
            </a>
            <a href="{{ url_for('commerciaux') }}" class="nav-link">
                <i class="fas fa-users"></i> Commerciaux
            </a>
            {% if current_user.role == 'admin' %}
            <a href="{{ url_for('gestion_utilisateurs') }}" class="nav-link">
                <i class="fas fa-cog"></i> Paramètres
            </a>
            {% endif %}
            
            <div class="user-info">
                <span>
                    <i class="fas fa-user"></i> {{ current_user.username }}
                    <span class="user-role">{{ current_user.role|upper }}</span>
                </span>
                <a href="{{ url_for('logout') }}" class="btn btn-danger btn-small">
                    <i class="fas fa-sign-out-alt"></i> Déconnexion
                </a>
            </div>
        </div>
    </div>

    <div class="container">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">
                        <i class="fas fa-{% if category == 'success' %}check-circle{% else %}exclamation-circle{% endif %}"></i>
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="content">
            <div class="d-flex justify-between align-center mb-30">
                <h2><i class="fas fa-edit"></i> Modifier la Créance #{{ creance.id }}</h2>
                <div class="btn-group">
                    <a href="{{ url_for('liste_creances') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Retour à la liste
                    </a>
                    <a href="{{ url_for('detail_client', client_name=creance.client.replace(' ', '_')) }}" class="btn btn-info">
                        <i class="fas fa-user"></i> Voir le client
                    </a>
                </div>
            </div>

            <!-- Informations de la créance -->
            <div class="creance-info">
                <h4><i class="fas fa-info-circle"></i> Informations de la créance</h4>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">Commercial</div>
                        <div class="info-value">{{ creance.commercial }}</div>
                    </div>
                    
                    <div class="info-item">
                        <div class="info-label">Client</div>
                        <div class="info-value">{{ creance.client }}</div>
                    </div>
                    
                    <div class="info-item">
                        <div class="info-label">Marché</div>
                        <div class="info-value">{{ creance.marche }}</div>
                    </div>
                    
                    <div class="info-item">
                        <div class="info-label">Date création</div>
                        <div class="info-value">{{ creance.date_creation|format_date }}</div>
                    </div>
                    
                    <div class="info-item">
                        <div class="info-label">Statut</div>
                        <div class="info-value">
                            <span class="statut-badge statut-{{ creance.statut|lower|replace(' ', '-')|replace('à', 'a') }}">
                                {{ creance.statut }}
                            </span>
                        </div>
                    </div>
                    
                    <div class="info-item">
                        <div class="info-label">Situation</div>
                        <div class="info-value">{{ creance.situation_paiement }}</div>
                    </div>
                </div>
            </div>

            <form method="POST" action="{{ url_for('modifier_creance', id=creance.id) }}" id="modifierForm" onsubmit="return validerForm()">
                <!-- Section Montants -->
                <div class="montant-section">
                    <h4><i class="fas fa-money-bill-wave"></i> Mise à jour des montants</h4>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Montant initial</label>
                            <input type="text" class="form-control" value="{{ creance.montant|format_money }}" readonly>
                        </div>
                        
                        <div class="form-group">
                            <label for="versement" class="required">Nouveau versement (FCFA)</label>
                            <input type="number" id="versement" name="versement" class="form-control" 
                                   value="{{ creance.versement }}" min="0" max="{{ creance.montant }}" step="50" 
                                   required data-format="cfa" data-round="50" oninput="calculerNouveauSolde()">
                            <div style="font-size: 13px; color: #7f8c8d; margin-top: 5px;">
                                Maximum: {{ creance.montant|format_money }}
                            </div>
                        </div>
                    </div>
                    
                    <div class="montant-calc">
                        <div class="montant-item">
                            <div class="montant-label">Montant Initial</div>
                            <div class="montant-value">{{ creance.montant|format_money }}</div>
                        </div>
                        
                        <div class="montant-item">
                            <div class="montant-label">Ancien Versement</div>
                            <div class="montant-value">{{ creance.versement|format_money }}</div>
                        </div>
                        
                        <div class="montant-item" style="background: #f0f7ff;">
                            <div class="montant-label">Nouveau Solde</div>
                            <div class="montant-value" id="nouveau_solde">{{ creance.solde|format_money }}</div>
                        </div>
                    </div>
                </div>

                <!-- Section Dates -->
                <div class="creance-info">
                    <h4><i class="fas fa-calendar-alt"></i> Mise à jour des dates</h4>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="date_echeance">Date d'échéance</label>
                            <input type="date" id="date_echeance" name="date_echeance" class="form-control" 
                                   value="{{ creance.date_echeance.strftime('%Y-%m-%d') if creance.date_echeance }}">
                            <div style="font-size: 13px; color: #7f8c8d; margin-top: 5px;">
                                Laisser vide pour conserver la date actuelle
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Jours de retard</label>
                            <input type="text" class="form-control" 
                                   value="{% if creance.jours_retard %}{{ creance.jours_retard }} jours{% else %}Non applicable{% endif %}" readonly>
                        </div>
                    </div>
                </div>

                <!-- Section Commentaires -->
                <div class="creance-info">
                    <h4><i class="fas fa-comment"></i> Commentaires</h4>
                    
                    <div class="form-group">
                        <label for="commentaires">Informations complémentaires</label>
                        <textarea id="commentaires" name="commentaires" class="form-control" 
                                  rows="4" placeholder="Mettez à jour les informations sur cette créance...">{{ creance.commentaires or '' }}</textarea>
                    </div>
                </div>

                <!-- Boutons d'action -->
                <div class="d-flex justify-between align-center mt-40">
                    <div>
                        <a href="{{ url_for('liste_creances') }}" class="btn btn-secondary">
                            <i class="fas fa-times"></i> Annuler
                        </a>
                    </div>
                    
                    <div class="btn-group">
                        <button type="submit" class="btn btn-success btn-large">
                            <i class="fas fa-save"></i> Enregistrer les modifications
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer">
        <p>Suivi des Créances - SOCoMA &copy; {{ now.year }}</p>
        <p class="footer-links">
            <a href="{{ url_for('accueil') }}">Accueil</a> • 
            <a href="{{ url_for('tableau_bord') }}">Tableau de bord</a> • 
            <a href="{{ url_for('commerciaux') }}">Commerciaux</a>
        </p>
    </div>

    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script>
        function formatCFA(number) {
            return new Intl.NumberFormat('fr-FR').format(Math.round(number)) + ' FCFA';
        }

        function calculerNouveauSolde() {
            const montantInitial = {{ creance.montant }};
            const nouveauVersement = parseFloat(document.getElementById('versement').value) || 0;
            const nouveauSolde = montantInitial - nouveauVersement;
            
            document.getElementById('nouveau_solde').textContent = formatCFA(nouveauSolde);
            
            // Changer la couleur si solde négatif
            const soldeElement = document.getElementById('nouveau_solde');
            if (nouveauSolde < 0) {
                soldeElement.style.color = '#e74c3c';
            } else if (nouveauSolde === 0) {
                soldeElement.style.color = '#27ae60';
            } else {
                soldeElement.style.color = '#2c3e50';
            }
        }

        function validerForm() {
            const versement = parseFloat(document.getElementById('versement').value) || 0;
            const montantInitial = {{ creance.montant }};
            
            if (versement < 0) {
                alert('Le versement ne peut pas être négatif');
                return false;
            }
            
            if (versement > montantInitial) {
                alert('Le versement ne peut pas dépasser le montant initial de la créance');
                return false;
            }
            
            return true;
        }

        // Initialiser le calcul au chargement
        document.addEventListener('DOMContentLoaded', function() {
            calculerNouveauSolde();
        });
    </script>
</body>
</html>